# Open Badges in Guidesmiths!

## Documentation

### Environments

_Blaze plan must be enabled for Slack notifications (external http traffic)_

**Details**
- Staging: `gs-open-badges-staging`
- Live: `gs-open-badges-live`

## Dependencies

### Production

- `email-validator@^2.0.4`
- `firebase-admin@^8.0.0`
- `firebase-functions@^3.1.0`
- `request@^2.88.0`
- `request-promise@^4.2.4`

### Development (only)

- `firebase-functions-test@^0.1.6`
- `jest@^24.9.0`
- `nock@^11.3.5`
- `standard@^14.3.1`

### Cloud services

- Firebase Functions
- Firebase Realtime Database

## Database

We are using [Firebase Realtime Database](https://firebase.google.com/products/realtime-database/)

### Rules

Only the Firebase Functions are capable of read/write Database content. Rules applied are in [./database.rules.json](/database.rules.json) as follow:

```json
{
  "rules": {
    ".read": false,
    ".write": false
  }
}
```

### Important

- The `userId` is generated by apply base64 for user's email address.
- The `badgeId` is provided by Badgr API

### Tokens Structure

Path: `/secrets/badgr`
Content:

```json
{
  "access_token" : "-----TOKEN-------",
  "expires_in" : 86400,
  "refresh_token" : "-----ANOTHER_TOKEN-------",
  "scope" : "rw:profile rw:issuer rw:backpack",
  "token_type" : "Bearer"
}
```

### User and user badges Structure

Path: `/data/users/{userId}` and `/data/users/{userId}/badges/{badgeId}`
Content:

```json
{
  "badges" : {
    "EHLRWpv2TW6_6h7zDLrUiA" : {
      "createdAt" : "2019-09-09T14:20:12Z",
      "createdBy" : "mAtisF97RKyJkoBPNMRCcQ",
      "criteriaNarrative" : "You are a GuideSmiths member",
      "criteriaUrl" : "https://guidesmiths.com",
      "description" : "You are part of the GuideSmiths' team",
      "entityId" : "EHLRWpv2TW6_6h7zDLrUiA",
      "entityType" : "BadgeClass",
      "image" : "https://media.badgr.io/uploads/badges/issuer_badgeclass_bd775ff3-2dba-49d1-a14b-9920f013b760.png",
      "issuedOn" : "2019-09-25T07:51:07.170971Z",
      "issuer" : "ltDx80nBQoOHgNwT0FLfWg",
      "issuerOpenBadgeId" : "https://api.badgr.io/public/issuers/ltDx80nBQoOHgNwT0FLfWg",
      "name" : "GuideSmiths Member!",
      "openBadgeId" : "https://api.badgr.io/public/badges/EHLRWpv2TW6_6h7zDLrUiA",
      "revoked" : false,
      "tags" : [ "employee", "membership", "culture" ]
    }
  },
  "bambooPersonID" : "42",
  "bambooSupervisorID" : "3",
  "department" : "Desarrollo",
  "email" : "ulises.gascon@guidesmiths.com",
  "jobTitle" : "Desarrollador Sénior",
  "location" : "WeWork Madrid",
  "name" : "Ulises González",
  "photo" : "https://images4.bamboohr.com/142160/photos/42-0-4.jpg?Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9pbWFnZXM0LmJhbWJvb2hyLmNvbS8xNDIxNjAvKiIsIkNvbmRpdGlvbiI6eyJEYXRlR3JlYXRlclRoYW4iOnsiQVdTOkVwb2NoVGltZSI6MTU2OTk5ODEyNX0sIkRhdGVMZXNzVGhhbiI6eyJBV1M6RXBvY2hUaW1lIjoxNTcyNTkwMTI2fX19XX0_&Signature=ZNLdkbqacDIMX69AFAvvqBq~YSMnZLlUklSEBTgpvUagguicKy2PUGJDoaqnE7cM0qQjDYw0CFvGToRXycW4Am8RcfpndvQuTIBJTdFzJlQDoFSOxGLimu4xjEowTC2EGFaT9INKdobwbJ2FIEzORWMQaglGeC~2hCY8G5xvi1u3evLOAXPZoy9oDghhD0VD3qG2zTReKTCKLQrlUX3UmKTnGEyq0RjMMY55m6y-F0rTiQJ88f99471~sOUSSLitBHXFWzjD5TN19VCF0XW5KaYVvuk7xTuGaAsjbBNgM2DWm0CyX8FUB0j7tGRiqgkNY0v4H69m21YToCtyRT2Ztw__&Key-Pair-Id=APKAIZ7QQNDH4DJY7K4Q",
  "slackUser" : "@ulisesgascon",
  "uuid" : "4e3de0a0a389ce701c0ae1413e25e393"
}
```

### Issuer Badges

Path: `data/badgr/badges/{badgeId}`
Content:

```json
{
  "createdAt" : "2019-09-24T08:25:29Z",
  "createdBy" : "lggCaZPAQnSB_O9PPt5RSA",
  "criteriaNarrative" : "Give at least 5 Knowledge Sharing",
  "description" : "You have given at least 5 Knowledge Sharing",
  "entityId" : "0bB5kY5GQbeAM5wETTWvEQ",
  "entityType" : "BadgeClass",
  "image" : "https://media.badgr.io/uploads/badges/issuer_badgeclass_f5c9bdfe-d29a-49d9-8c7f-00369d87ad11.png",
  "issuer" : "ltDx80nBQoOHgNwT0FLfWg",
  "issuerOpenBadgeId" : "https://api.badgr.io/public/issuers/ltDx80nBQoOHgNwT0FLfWg",
  "name" : "KS Contributor",
  "openBadgeId" : "https://api.badgr.io/public/badges/0bB5kY5GQbeAM5wETTWvEQ",
  "tags" : [ "ks", "contributor", "cultural" ]
}
```

### Tests

You can start the tests by running `npm run test` in the terminal. The tests are using Jest.

### How to deploy?

- `$ npm install -g firebase-tools`
- `$ firebase init` _(optional)_
- `$ firebase deploy`